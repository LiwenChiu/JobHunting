@{
    ViewData["Title"] = "訂單紀錄";
}

@section Styles
{
    <style>

    </style>
}


<div class="container tableOutside pt-1" id="appCompanyOrders" style="position: relative">

    @* 通知 *@
    <template v-if="alertStatus == '成功'">
        <div id="alert" class="alert alert-primary alert-dismissible fade show" role="alert" style="position: absolute">
            <strong>{{alertText}}</strong>
            <button type="button" class="btn-close" aria-label="Close" v-on:click="alertStatus=''"></button>
        </div>
    </template>
    <template v-else-if="alertStatus == '失敗'">
        <div id="alert" class="alert alert-danger alert-dismissible fade show" role="alert" style="position: absolute">
            <strong>{{alertText}}</strong>
            <button type="button" class="btn-close" aria-label="Close" v-on:click="alertStatus=''"></button>
        </div>
    </template>

    <div class="row">
        <h1 class="col-sm-8">最終日期: {{deadline}}</h1>
        <div class="col-sm-4">
            <input id="searchOrder" class="form-control" placeholder="搜尋關鍵字" v-model="searchOrderInput" />
        </div>
    </div>

    <div style="overflow-y:auto;height:81vh">
        <table id="orderTable" class="table table-striped table-hover">
            <thead>
                <tr>
                    <td>方案</td>
                    <td>天數</td>
                    <td>價格</td>
                    <td>下單時間</td>
                    <td>付款時間</td>
                    <td>付款狀態</td>
                    <td></td>
                </tr>
            </thead>
            <tbody>
                <tr v-for="order in orders">
                    <td>{{order.title}}</td>
                    <td>{{order.duration}}</td>
                    <td>{{order.price}}</td>
                    <td>{{order.orderDate}}</td>
                    <td>{{order.payDate == null ? "無" : order.payDate}}</td>
                    <td>{{order.statusType}}</td>
                    <td>
                        <template v-if="!order.status">
                            <button type="button" class="btn btn-danger text-light" v-on:click="cancelOrder(order.orderId)">取消</button>
                        </template>
                        <template v-else>
                            <button type="button" class="btn btn-outline-secondary" v-on:click="SendToNewebPaySearch(order.orderId)">詳情</button>
                        </template>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

</div>

@section Scripts
{
    <script>
        let vueAppCompanyOrders = {
            data() {
                return {
                    baseAddress: "https://localhost:7169",
                    orders: [],
                    deadline: null,
                    searchOrderInput: "",
                    alertText: "",
                    alertStatus: "",
                }
            },
            computed: {},
            methods: {
                getCompanyOrders: function () {
                    let request = {};
                    request.Filter = this.searchOrderInput;
                    axios.post(`${this.baseAddress}/Companies/CompanyOrders/GetCompanyOrders`, request, {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    }).then(response => this.orders = response.data)
                        .catch(err => { alert(err) });

                    // 拿Companies裡的Deadline
                    axios.post(`${this.baseAddress}/Companies/CompanyOrders/GetDeadline`, {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    }).then(response => this.deadline = response.data == null ? "無" : response.data)
                        .catch(err => { alert(err) });
                },
                showDeadline() {
                    return this.deadline === null ? "請購買方案" : this.deadline;
                },
                SendToNewebPaySearch:function(orderId){
                    var self = this;

                    // 訂單Id
                    var postData = {};
                    postData['OrderId'] = orderId;

                    axios.post(`${self.baseAddress}/Companies/CompanyOrders/SendToNewebPaySearch`, postData,{
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(response => {
                            const returnObj = response.data;

                            // 呼叫藍新金流 API
                            const form = document.createElement('form');
                            form.method = 'post';
                            form.action = 'https://ccore.newebpay.com/API/QueryTradeInfo'; // 藍新金流單筆交易查詢驗證網址(測試環境)
                            // form.action = 'https://core.newebpay.com/API/QueryTradeInfo'; // 藍新金流單筆交易查詢正式網址

                            for (const key in returnObj) {
                                if (returnObj.hasOwnProperty(key)) {
                                    const hiddenField = document.createElement('input');
                                    hiddenField.type = 'hidden';
                                    hiddenField.name = key;
                                    hiddenField.value = returnObj[key];
                                    form.appendChild(hiddenField);
                                }
                            }
                            document.body.appendChild(form);
                            form.submit();
                        })
                        .catch(error => {
                            alert(error.response.status + " " + error.response.statusText + '\n' + error.response.data);
                        });
                },
                cancelOrder: function (orderId) {
                    let request = { OrderId: orderId };
                    axios.post(`${this.baseAddress}/Companies/CompanyOrders/CancelOrder`, request, {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    }).then(response => {
                        this.alertText = response.data[0];
                        this.alertStatus = response.data[1];
                        this.getCompanyOrders();
                        this.alertOut();
                    }).catch(err => { alert(err) });
                },
                alertOut: function () {
                    let time = window.setTimeout((() => this.alertStatus = ""), 5000);
                },
            },
            watch: {
                searchOrderInput: function () {
                    this.getCompanyOrders();
                },
            },
            mounted: function () {
                this.getCompanyOrders();
            },
        };
        let app = Vue.createApp(vueAppCompanyOrders).mount("#appCompanyOrders");
    </script>
}
